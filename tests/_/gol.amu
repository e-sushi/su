rnext: s32 = 1213314;
rand :: () -> s32 {
    rnext = rnext * 1103515245 + 12345;
    ret := (rnext/65536) % 32768;
    ret
}


width :: (s32)10;
height :: (s32)10;
area :: width * height;

A: u8[area];
B: u8[area];
active := &A;
next := &B;

coord :: (x: s32, y: s32) -> s32 {
    ((x % width) + width) % width * width + (((y % height) + height) % height)
}

live :: (x: s32, y: s32) -> void { 
    (*next)[coord(x,y)] = 1;
}

die :: (x: s32, y: s32) -> void { 
    (*next)[coord(x,y)] = 0;
}

count_neighbors :: (x: s32, y: s32) -> s32 {
    (*active)[coord(x-1, y  )] +
	(*active)[coord(x+1, y  )] +
	(*active)[coord(x,   y+1)] +
	(*active)[coord(x,   y-1)] +
	(*active)[coord(x-1, y+1)] +
	(*active)[coord(x+1, y+1)] +
	(*active)[coord(x-1, y-1)] +
	(*active)[coord(x+1, y-1)]
}



main :: () -> void {

	for(i: 0..A.count)
       (*active)[i] = #rand_int % 2;

	A = [
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,1,0,0,0,0,0,
		0,0,0,0,1,0,0,0,0,0,
		0,0,0,0,1,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
		0,0,0,0,0,0,0,0,0,0,
	];
	
	#vm_break;

	test := count_neighbors(3,2);
	
	arr := *active;
	n := *next;

    loop {
        for(x: 0..width) {
            for(y: 0..height) {
                N := count_neighbors(x,y); 
                if((*active)[coord(x,y)]) {
                    if(N < 2 || N >= 4) {
                        die(x,y);
                    } else {
                        live(x,y);
                    }
                } else if(N==3) {
                    live(x,y);
                } else {
                    die(x,y);
                }
				n = *next;
            }
        }
        save := active;
        active = next;
        next = save;
        arr = *active;

		//for(i: 0..area) {
		//	(*next)[i] = 0;
		//}
		
		alive := 0;
		for(i: 0..area) {
			if((*active)[i]) {
				alive = 1;
				break;
			}
		}

		if(alive == 0) {
			for(i: 0..area) {
				(*active)[i] = #rand_int % 2;
			}
		}
		#vm_break;
    }
}
